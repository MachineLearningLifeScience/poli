[tox]
env_list =
    lint
    poli-base-py39
minversion = 4.10.0

[testenv]
description = run the tests with pytest
package = wheel
wheel_build_env = .pkg
allowlist_externals =
    sh
deps =
    pytest>=6
commands =
    sh -c "rm -rf ~/.poli_objectives/*.sh"
    sh -c "rm -rf ~/.poli_objectives/config.rc"
    sh -c 'if conda info --envs | grep -q poli__base; then echo "poli__base already exists"; else conda env create -f ./src/poli/objective_repository/aloha/environment.yml; fi'
    sh -c "conda run -n poli__base python -m pip uninstall -y poli"
    sh -c "conda run -n poli__base python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__chem; then echo "poli__chem already exists"; else conda env create -f ./src/poli/objective_repository/rdkit_qed/environment.yml; fi'
    sh -c "conda run -n poli__chem python -m pip uninstall -y poli"
    sh -c "conda run -n poli__chem python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__protein; then echo "poli__protein already exists"; else conda env create -f ./src/poli/objective_repository/foldx_stability/environment.yml; fi'
    sh -c "conda run -n poli__protein python -m pip uninstall -y poli"
    sh -c "conda run -n poli__protein python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__protein_cbas; then echo "poli__protein_cbas already exists"; else conda env create -f ./src/poli/objective_repository/gfp_cbas/environment.yml; fi'
    sh -c "conda run -n poli__protein_cbas python -m pip uninstall -y poli"
    sh -c "conda run -n poli__protein_cbas python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__dockstring; then echo "poli__dockstring already exists"; else conda env create -f ./src/poli/objective_repository/dockstring/environment.yml; fi'
    sh -c "conda run -n poli__dockstring python -m pip uninstall -y poli"
    sh -c "conda run -n poli__dockstring python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__tdc; then echo "poli__tdc already exists"; else conda env create -f ./src/poli/objective_repository/sa_tdc/environment.yml; fi'
    sh -c "conda run -n poli__tdc python -m pip uninstall -y poli"
    sh -c "conda run -n poli__tdc python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__lambo; then echo "poli__lambo already exists"; else conda env create -f ./src/poli/objective_repository/foldx_rfp_lambo/environment.yml; fi'
    sh -c "conda run -n poli__lambo python -m pip uninstall -y poli"
    sh -c "conda run -n poli__lambo python -m pip install -e ."
    sh -c 'if conda info --envs | grep -q poli__rasp; then echo "poli__rasp already exists"; else conda env create -f ./src/poli/objective_repository/rasp/environment.yml; fi'
    sh -c "conda run -n poli__rasp python -m pip uninstall -y poli"
    sh -c "conda run -n poli__rasp python -m pip install -e ."
    pytest {tty:--color=yes} -v {posargs}
    sh -c "rm -rf ~/.poli_objectives/*.sh"
    sh -c "rm -rf ~/.poli_objectives/config.rc"

[testenv:lint]
description = check the code style with black
deps =
    black
commands =
    black --check --diff .

[testenv:poli-base-py39]
description = run the tests with pytest on the base environment for poli
basepython = python3.9
wheel_build_env = .pkg
deps=
    {[testenv]deps}
    numpy
    -e.
commands=
    {[testenv]commands}
